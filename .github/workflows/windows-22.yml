name: Enable RDP on Windows VPS

on:
  workflow_dispatch:

jobs:
  enable-rdp:
    runs-on: windows-2022

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set user password
      run: |
        $Username = "Administrator"
        $Password = "YourStrongPassword"
        $SecurePassword = ConvertTo-SecureString $Password -AsPlainText -Force
        $User = Get-LocalUser -Name $Username
        if ($User) {
            Write-Host "Updating password for $Username"
            $User | Set-LocalUser -Password $SecurePassword
        } else {
            Write-Host "User $Username not found. Creating user..."
            New-LocalUser -Name $Username -Password $SecurePassword -FullName "Admin User" -Description "RDP User"
        }
      shell: powershell

    - name: Enable RDP
      run: |
        Write-Host "Enabling RDP..."
        Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
        Write-Host "RDP enabled."
      shell: powershell

    - name: Allow RDP in firewall
      run: |
        Write-Host "Opening firewall for RDP..."
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Write-Host "Firewall configured."
      shell: powershell

    - name: Confirm RDP status
      run: |
        $RDPStatus = Get-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections"
        if ($RDPStatus.fDenyTSConnections -eq 0) {
            Write-Host "RDP is enabled."
        } else {
            throw "RDP not enabled."
        }
      shell: powershell